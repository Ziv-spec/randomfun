#include <stdlib.h>
#include <stdio.h>

static unsigned short program[] = {
	//
	// Instructions
	//
	0x7000, // format 
	0x7CF0, // colorline
	0x3822, // rectangle
	0x7C70, // colorline
	0x9002, 0x0024, // vector
	0x9002, 0x0026, // vector
	0x9002, 0x0028, // vector
	0x9002, 0x002A, // vector
	0x9002, 0x002C, // vector
	0x9002, 0x002E, // vector
	0x9002, 0x0030, // vector
	0x9002, 0x0032, // vector
	0x7CD0, // colorline
	0x9808, 0x0033, // circle
	0x7CE0, // colorline
	0x9808, 0x0033, // circle
	0x7CC0, // colorline  
	0x8904, 0x0033, // alpha
	0x7CA0, // colorline
	0x8914, 0x0035, // alpha
	0x7C90, // colorline
	0x8914, 0x003F, // alpha
	0x0803, // halt/end
	//
	// Data
	// 
	0x0000, 
	0x0000, 
	0x0C80, 
	0x0C80, 
	0x7CA5, 
	0x0640, 
	0xFCA5, 
	0x79C1, 
	0x035C, 
	0x0640, 
	0x835C, 
	0x79C1, 
	0x79C1, 
	0x035C, 
	0x8640, 
	0x035C, 
	0x79C1, 
	0x0000, 
	0xFE53, 
	0x0000,
	0x01AE, 
	0x0000,
	0x8640, 
	0x0000,
	0x79C1, 
	0x7CA5,
	0x8640,
	0x7CA5,
	0x0000,
	0x0640,
	0x8000,
	0x01AE,
	0x0000,
	0x7E53,
	0x8000,
	0x79C1,
	0x0000,
	0x0000,
	0x0640,
	0x0000,
	0x0000,
	0x0350,
	0x1F70,
	0x0000,
	0x0000,
	0x1405,
	0x1314,
	0x1D78,
	0x06A4,
	0x0000,
	0x5354,
	0x4943,
	0x4B00,
	0x464F,
	0x5243,
	0x4500,
	0x2D00,
	0x7271,
	0x2E74,
	0x7000,
	0x1D78,
	0x195C,
	0x0000,
	0x4655,
	0x454C,
	0x0051,
	0x5459,
	0x002D,
	0x0076,
	0x7070,
	0x7000,
	0x4C42,
	0x5300
};

static unsigned short blue_patch[] = {
	// Instructions
	0x7000, 
	0x7c90,
	0x9026, 0x0009,
	0x902c, 0x0053, 
	0x902e, 0x00a9,
	0x902c, 0x0103,
	0x0803,
	// Data 
	0x7eab, 0x150,
	0x8155, 0x150,
	0x0155, 0x148,
	0xfeab, 0x148,
	0x7eab, 0x140,
	0x8155, 0x140,
	0x0155, 0x138,
	0xfeab, 0x138,
	0x7eab, 0x130,
	0x8155, 0x130,
	0x0155, 0x128,
	0xfeab, 0x128,
	0x7eab, 0x120,
	0x8155, 0x120,
	0x0155, 0x118,
	0xfeab, 0x118,
	0x7eab, 0x110,
	0x8155, 0x110,
	0x0155, 0x108,
	0xfeab, 0x108,
	0x7eab, 0x100,
	0x8155, 0x100,
	0x0155, 0xf8,
	0xfeab, 0xf8,
	0x7eab, 0xf0,
	0x8155, 0xf0,
	0x0155, 0xe8,
	0xfeab, 0xe8,
	0x7eab, 0xe0,
	0x8155, 0xe0,
	0x0155, 0xd8,
	0xfeab, 0xd8,
	0x7eab, 0xd0,
	0x8155, 0xd0,
	0x0155, 0xc8,
	0xfeab, 0xc8,
	0x7eab, 0xc0,
	0x8155, 0xc0,
	0x0155, 0xb8,
	0xfeab, 0xb8,
	0x7eab, 0xb0,
	0x8155, 0xb0,
	0x0155, 0xa8,
	0xfeab, 0xa8,
	0x7eab, 0xa0,
	0x8155, 0xa0,
	0x0155, 0x98,
	0xfeab, 0x98,
	0x7eab, 0x90,
	0x8155, 0x90,
	0x0155, 0x88,
	0xfeab, 0x88,
	0x7eab, 0x80,
	0x8155, 0x80,
	0x0155, 0x78,
	0xfeab, 0x78,
	0x7eab, 0x70,
	0x8155, 0x70,
	0x0155, 0x68,
	0xfeab, 0x68,
	0x7eab, 0x60,
	0x8155, 0x60,
	0x0155, 0x58,
	0xfeab, 0x58,
	0x7eab, 0x50,
	0x8155, 0x50,
	0x0155, 0x48,
	0xfeab, 0x48,
	0x7eab, 0x40,
	0x8155, 0x40,
	0x0155, 0x38,
	0xfeab, 0x38,
	0x7eab, 0x30,
	0x8155, 0x30,
	0x0155, 0x28,
	0xfeab, 0x28,
	0x7eab, 0x20,
	0x8155, 0x20,
	0x0155, 0x18,
	0xfeab, 0x18,
	0x7eab, 0x10,
	0x8155, 0x10,
	0x0155, 0x8,
	0xfeab, 0x8,
	0x7eab, 0x0,
	0x8155, 0x0,
	0x0155, 0x7ff8,
	0xfeab, 0x7ff8,
	0x7eab, 0x7ff0,
	0x8155, 0x7ff0,
	0x0155, 0x7fe8,
	0xfeab, 0x7fe8,
	0x7eab, 0x7fe0,
	0x8155, 0x7fe0,
	0x0155, 0x7fd8,
	0xfeab, 0x7fd8,
	0x7eab, 0x7fd0,
	0x8155, 0x7fd0,
	0x0155, 0x7fc8,
	0xfeab, 0x7fc8,
	0x7eab, 0x7fc0,
	0x8155, 0x7fc0,
	0x0155, 0x7fb8,
	0xfeab, 0x7fb8,
	0x7eab, 0x7fb0,
	0x8155, 0x7fb0,
	0x0155, 0x7fa8,
	0xfeab, 0x7fa8,
	0x7eab, 0x7fa0,
	0x8155, 0x7fa0,
	0x0155, 0x7f98,
	0xfeab, 0x7f98,
	0x7eab, 0x7f90,
	0x8155, 0x7f90,
	0x0155, 0x7f88,
	0xfeab, 0x7f88,
	0x7eab, 0x7f80,
	0x8155, 0x7f80,
	0x0155, 0x7f78,
	0xfeab, 0x7f78,
	0x7eab, 0x7f70,
	0x8155, 0x7f70,
	0x0155, 0x7f68,
	0xfeab, 0x7f68,
	0x7eab, 0x7f60,
	0x8155, 0x7f60,
	0x0155, 0x7f58,
	0xfeab, 0x7f58,
	0x7eab, 0x7f50,
	0x8155, 0x7f50,
	0x0155, 0x7f48,
	0xfeab, 0x7f48,
	0x7eab, 0x7f40,
	0x8155, 0x7f40,
	0x0155, 0x7f38,
	0xfeab, 0x7f38,
	0x7eab, 0x7f30,
	0x8155, 0x7f30,
	0x0155, 0x7f28,
	0xfeab, 0x7f28,
	0x7eab, 0x7f20,
	0x8155, 0x7f20,
	0x0155, 0x7f18,
	0xfeab, 0x7f18,
	0x7eab, 0x7f10,
	0x8155, 0x7f10,
	0x0155, 0x7f08,
	0xfeab, 0x7f08,
	0x7eab, 0x7f00,
	0x8155, 0x7f00,
	0x0155, 0x7ef8,
	0xfeab, 0x7ef8,
	0x7eab, 0x7ef0,
	0x8155, 0x7ef0,
	0x0155, 0x7ee8,
	0xfeab, 0x7ee8,
	0x7eab, 0x7ee0,
	0x8155, 0x7ee0,
	0x0155, 0x7ed8,
	0xfeab, 0x7ed8,
	0x7eab, 0x7ed0,
	0x8155, 0x7ed0,
	0x0155, 0x7ec8,
	0xfeab, 0x7ec8,
	0x7eab, 0x7ec0,
	0x8155, 0x7ec0,
	0x0155, 0x7eb8,
	0xfeab, 0x7eb8,
	0x7eab, 0x7eb0,
	0x8155, 0x7eb0,
	0x0155, 0x7ea8,
	0xfeab, 0x7ea8,
};


static void 
st_rect(short *code) {

	// offset to data
	short offset = *code & 0x7ff; 
	code = code + offset; 

	short xcenter = *code; 
	code = code + 1;
	short ycenter = *code; 
	code = code + 1;
	short xlen = *code;
	code = code + 1;
	short ylen = *code;

	printf("rectangle %d %d %d %d\n", xcenter, ycenter, xlen, ylen);
}

static char *colors[16] = {
	[0] = "color-off",
	[1] = "DIM BLUE",
	[2] = "DIM GREEN",
	[3] = "DIM CYAN",
	[4] = "DIM RED",
	[5] = "DIM MAGENTA",
	[6] = "DIM AMBER",
	[7] = "DIM WHITE",
	[8] = "ORANGE",
	[9] = "BLUE",
	[10] = "GREEN",
	[11] = "CYAN",
	[12] = "RED",
	[13] = "MAGENTA",
	[14] = "AMBER",
	[15] = "WHITE",
};

static void 
st_linecolor(short *code, int format) {

	short offset = *code & 0x03ff;
	code = code + offset;

	if (*code == 0x0) return;

	// mpcd
	short rgb = 0;
	if (format == 1) {
		if ((*code & 0x400) == 0) { 
			rgb = (*code >> 12) & 0xf;
		}
	}
	else { 
		if ((*code & 0x004) == 0) {
			rgb = (*code >> 4) & 0xf; 
		}
	}

	printf("colorline: %s\n", colors[rgb]);
}

static void 
st_vector(short *code) { 
	printf("vector: ");

	short xy_data_words = (*code & 0x01ff) + 1;
	printf("data words: %d\n", xy_data_words);
	code = code + 1;

	if ((*code & 0x800) == 0x8000) return; // flag should not reset
	code = code + (*code & 0x07ff) -1; // data offset

	for (int i = 0; i < xy_data_words; i++) {
		short xvec = *code; code = code + 1;
		short yvec = *code; code = code + 1;
		
		printf("\t(%hx, %hx) (%hi %hi)\n", xvec, yvec,  xvec &0xffff, yvec &0xffff);
	}
	printf("\n");
}

int main() { 

	if (blue_patch[0] != 0x7000) {
		printf("not format\n");
		return -1;
	}

	unsigned short *opcode = blue_patch + 1;
	unsigned short code = *opcode & 0xf800;


	while (code != 0x0800) {

		switch (code) {
			case 0x0000: { // NOP
				opcode = opcode + 1;
			} break;

			case 0x0800: { //terminator
				printf("halt\n");
		  } return 0;

			case 0x3800: {
				st_rect(opcode);
				opcode = opcode + 1;
		  } break;

			case 0x7000: {
				printf("second format is illegal\n");
			} return -1;

			case 0x7800: {
				int format = ((*opcode & 0x0400) == 0) ? 1 : 2;

				st_linecolor(opcode, format);

				if (format == 1) {
					opcode = opcode + 2;
				}
				else { // format 2
					opcode = opcode + 1;
				}
		  }	break;

			case 0x8000: {
				printf("line structure\n");
				opcode = opcode + 2;
		  } break;

			case 0x8800: {
				printf("alpha\n");  // maybe alphanumeric to place (how we render text)
				opcode = opcode + 2;
		  } break;
			 
			case 0x9000: { 
			  st_vector(opcode);
			  opcode = opcode + 2;
		  } break;

			case 0x9800: { 
				printf("conic\n"); 
				opcode = opcode + 2;
	 	  } break;
			default: { printf("what is going on here?\n"); return 0; }
		}

		code = *opcode & 0xf800;
	}

	return 0;
}




